<div id="theme-switcher" style="position: fixed; top: 20px; right: 20px; z-index: 10000;">
    <style>
        /* Global transition for theme switching */
        body {
            transition: opacity 0.3s ease-in-out;
            opacity: 1;
        }
        /* Prevent transitions during theme switch cleanup */
        body.no-transition, body.no-transition * {
            transition: none !important;
        }
    </style>
    <label for="theme-select">Select Theme:</label>
    <select id="theme-select" onchange="changeTheme(this.value)">
        <option value="clean">Clean (Default)</option>
        <option value="modern">Modern</option>
        <option value="classic">Classic</option>
        <option value="terminal">Terminal</option>
        <option value="bold">Bold</option>
    </select>

    <!-- Modern Theme Controls -->
    <div id="color-picker-container" style="display: none; margin-top: 10px;">
        <label for="color-select">Theme Color:</label>
        <select id="color-select" onchange="changeColor(this.value)">
            <option value="blue">Blue (Default)</option>
            <option value="red">Red</option>
            <option value="orange">Orange</option>
            <option value="green">Green</option>
            <option value="purple">Purple</option>
            <option value="black">Black</option>
            <option value="grey">Grey</option>
        </select>

        <label for="bg-select" style="margin-top: 10px; display: block;">Background:</label>
        <select id="bg-select" onchange="changeBackground(this.value)">
            <option value="bg-none">Clean (Default)</option>
            <option value="bg-gradient">Soft Gradient</option>
            <option value="bg-stripes">Modern Stripes</option>
            <option value="bg-dots">Polka Dots</option>
            <option value="bg-geometric">Geometric</option>
            <option value="bg-waves">Waves</option>
            <option value="bg-graph-paper">Graph Paper</option>
            <option value="bg-crosshatch">Crosshatch</option>
            <option value="bg-circles">Circles</option>
        </select>
    </div>

    <!-- Clean Theme Controls (Dark Mode) -->
    <div id="dark-mode-container" style="display: none; margin-top: 10px;">
        <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" id="dark-mode-toggle" onchange="toggleDarkMode(this.checked)" style="margin-right: 8px;">
            Dark Mode
        </label>
    </div>

    <!-- Classic Theme Controls (Reader View) -->
    <div id="reader-view-container" style="display: none; margin-top: 10px; border-top: 1px solid #ccc; padding-top: 10px;">
        <div style="margin-bottom: 8px;">
            <label for="reader-font">Font:</label>
            <select id="reader-font" onchange="updateReaderView()">
                <option value="'Merriweather', 'Georgia', serif">Merriweather</option>
                <option value="'Georgia', serif">Georgia</option>
                <option value="'Times New Roman', serif">Times New Roman</option>
                <option value="'Arial', sans-serif">Arial (Sans)</option>
            </select>
        </div>
        <div style="margin-bottom: 8px;">
            <label for="reader-size">Size:</label>
            <input type="range" id="reader-size" min="14" max="24" value="16" oninput="updateReaderView()" style="width: 100%;">
        </div>
        <div style="margin-bottom: 8px;">
            <label for="reader-texture">Paper:</label>
            <select id="reader-texture" onchange="updateReaderView()">
                <option value="none">Clean White</option>
                <option value="texture-paper">Cream Paper</option>
                <option value="texture-sepia">Sepia</option>
                <option value="texture-dark">Dark Reader</option>
            </select>
        </div>
    </div>
</div>

<script>
    function changeTheme(theme) {
        // Fade out content
        document.body.style.opacity = '0';

        // Wait for fade out to complete before swapping
        setTimeout(function() {
            // 1. Update stylesheet
            var link = document.getElementById('theme-style');
            if (link) {
                // Add timestamp to prevent caching issues during development
                link.href = 'theme-' + theme + '.css?v=' + new Date().getTime();
            }

            // Reset body classes
            document.body.className = '';

            // Hide all specific controls first
            document.getElementById('color-picker-container').style.display = 'none';
            document.getElementById('dark-mode-container').style.display = 'none';
            document.getElementById('reader-view-container').style.display = 'none';

            // Show specific controls based on theme
            if (theme === 'modern' || theme === 'bold') {
                document.getElementById('color-picker-container').style.display = 'block';
                var colorSelect = document.getElementById('color-select');
                changeColor(colorSelect.value);
                
                // Restore background for modern theme
                if (theme === 'modern') {
                    var bgSelect = document.getElementById('bg-select');
                    if (bgSelect) {
                        // Hide bg select for bold theme if we wanted, but here we just show it for modern
                        document.getElementById('bg-select').style.display = 'block';
                        document.querySelector('label[for="bg-select"]').style.display = 'block';
                        
                        // Clear any existing background layers to prevent stacking/darkening on theme switch
                        var bgContainer = document.getElementById('modern-background');
                        if (bgContainer) bgContainer.innerHTML = '';
                        
                        changeBackground(bgSelect.value);
                    }
                } else {
                    // Hide bg select for bold theme
                    document.getElementById('bg-select').style.display = 'none';
                    document.querySelector('label[for="bg-select"]').style.display = 'none';
                }
            } else if (theme === 'clean') {
                document.getElementById('dark-mode-container').style.display = 'block';
                // Restore dark mode state
                var isDark = localStorage.getItem('resume-dark-mode') === 'true';
                document.getElementById('dark-mode-toggle').checked = isDark;
                toggleDarkMode(isDark);
            } else if (theme === 'classic') {
                document.getElementById('reader-view-container').style.display = 'block';
                updateReaderView();
            } else {
                updatePdfLink(theme, null);
            }
            
            // Save preference
            localStorage.setItem('resume-theme', theme);

            // Fade in content after a short delay to allow CSS to parse
            setTimeout(function() {
                document.body.style.opacity = '1';
            }, 100);

        }, 300); // Match the transition duration (0.3s)
    }

    function changeColor(color) {
        var theme = document.getElementById('theme-select').value;
        var colors;

        if (theme === 'bold') {
             colors = {
                'blue': { main: '#0055ff', dark: '#0055ff' },
                'red': { main: '#ff0000', dark: '#ff0000' },
                'orange': { main: '#ff6600', dark: '#ff6600' },
                'green': { main: '#00aa00', dark: '#00aa00' },
                'purple': { main: '#8800cc', dark: '#8800cc' },
                'black': { main: '#000000', dark: '#000000' },
                'grey': { main: '#666666', dark: '#666666' }
            };
        } else {
            // Default to Modern colors
            colors = {
                'blue': { main: '#3498db', dark: '#2980b9' },
                'red': { main: '#e74c3c', dark: '#c0392b' },
                'orange': { main: '#e67e22', dark: '#d35400' },
                'green': { main: '#2ecc71', dark: '#27ae60' },
                'purple': { main: '#9b59b6', dark: '#8e44ad' },
                'black': { main: '#2c3e50', dark: '#1a252f' },
                'grey': { main: '#7f8c8d', dark: '#95a5a6' }
            };
        }

        var currentColor = localStorage.getItem('resume-modern-color') || (theme === 'bold' ? 'red' : 'blue');
        var oldColorObj = colors[currentColor] || colors[theme === 'bold' ? 'red' : 'blue'];
        var newColorObj = colors[color];

        // Set CSS variables for the wipe animation (text only)
        document.documentElement.style.setProperty('--old-color', oldColorObj.main);
        document.documentElement.style.setProperty('--new-color', newColorObj.main);
        
        // Set Dark variants for background gradients
        document.documentElement.style.setProperty('--old-color-dark', oldColorObj.dark);
        document.documentElement.style.setProperty('--new-color-dark', newColorObj.dark);

        // Handle Background Transition (Crossfade)
        var bgContainer = document.getElementById('modern-background');
        if (bgContainer) {
            // Get current background class
            var currentBgClass = localStorage.getItem('resume-modern-bg') || 'bg-none';
            
            // Create new layer with new color variables inline
            var newLayer = document.createElement('div');
            newLayer.className = 'bg-layer ' + currentBgClass;
            newLayer.style.setProperty('--accent-color', newColorObj.main);
            newLayer.style.setProperty('--accent-color-dark', newColorObj.dark);
            bgContainer.appendChild(newLayer);
            
            // Trigger reflow
            void newLayer.offsetWidth;
            
            // Fade in
            newLayer.classList.add('active');
            
            // Remove old layers after transition
            var oldLayers = bgContainer.querySelectorAll('.bg-layer:not(:last-child)');
            oldLayers.forEach(function(layer) {
                layer.classList.remove('active');
                setTimeout(function() {
                    if (layer.parentNode) {
                        layer.parentNode.removeChild(layer);
                    }
                }, 500);
            });
        }

        // Add wiping class to trigger text animation
        document.body.classList.add('wiping');

        // Wait for animation to complete
        setTimeout(function() {
            // Disable transitions temporarily to prevent flashing
            document.body.classList.add('no-transition');
            
            document.body.classList.remove('wiping');
            
            // Remove any existing color-* classes
            var classes = document.body.className.split(' ');
            for (var i = 0; i < classes.length; i++) {
                if (classes[i].startsWith('color-')) {
                    document.body.classList.remove(classes[i]);
                }
            }
            
            document.body.classList.add('color-' + color);
            
            // Clean up inline styles on the active layer so it respects future global changes
            if (bgContainer) {
                var activeLayer = bgContainer.lastElementChild;
                if (activeLayer) {
                    activeLayer.style.removeProperty('--accent-color');
                    activeLayer.style.removeProperty('--accent-color-dark');
                }
            }
            
            updatePdfLink(theme, color);
            localStorage.setItem('resume-modern-color', color);
            
            // Re-enable transitions after a brief moment
            setTimeout(function() {
                document.body.classList.remove('no-transition');
            }, 50);
        }, 1500); // Match animation duration
    }

    function changeBackground(bgClass) {
        // Ensure background container exists
        var bgContainer = document.getElementById('modern-background');
        if (!bgContainer) {
            bgContainer = document.createElement('div');
            bgContainer.id = 'modern-background';
            document.body.prepend(bgContainer);
        }

        // Create a new layer for the new background
        var newLayer = document.createElement('div');
        newLayer.className = 'bg-layer ' + bgClass;
        bgContainer.appendChild(newLayer);

        // Trigger reflow to ensure transition happens
        void newLayer.offsetWidth;

        // Fade in new layer
        newLayer.classList.add('active');

        // Update body class for the wipe animation to know which pattern to use
        // Remove existing bg classes from body
        document.body.classList.remove('bg-none', 'bg-gradient', 'bg-stripes', 'bg-dots', 'bg-geometric', 'bg-waves', 'bg-graph-paper', 'bg-crosshatch', 'bg-circles');
        document.body.classList.add(bgClass);

        // Remove old layers after transition
        var oldLayers = bgContainer.querySelectorAll('.bg-layer:not(:last-child)');
        oldLayers.forEach(function(layer) {
            layer.classList.remove('active');
            setTimeout(function() {
                if (layer.parentNode) {
                    layer.parentNode.removeChild(layer);
                }
            }, 500); // Match CSS transition time
        });
        
        // Save preference
        localStorage.setItem('resume-modern-bg', bgClass);
    }

    function toggleDarkMode(isDark) {
        if (isDark) {
            document.body.classList.add('dark-mode');
        } else {
            document.body.classList.remove('dark-mode');
        }
        localStorage.setItem('resume-dark-mode', isDark);
        
        // Update PDF link for dark mode
        if (isDark) {
            updatePdfLink('clean', 'dark');
        } else {
            updatePdfLink('clean', null);
        }
    }

    function updateReaderView() {
        var fontValue = document.getElementById('reader-font').value;
        var size = document.getElementById('reader-size').value + 'px';
        var texture = document.getElementById('reader-texture').value;

        document.documentElement.style.setProperty('--classic-font-family', fontValue);
        document.documentElement.style.setProperty('--classic-font-size', size);
        
        // Remove old texture and font classes
        document.body.classList.remove('texture-paper', 'texture-sepia', 'texture-dark');
        document.body.classList.remove('font-merriweather', 'font-georgia', 'font-times', 'font-arial');
        
        if (texture !== 'none') {
            document.body.classList.add(texture);
        }
        
        // Map font value to class name for PDF generation consistency
        var fontClass = 'merriweather'; // default
        if (fontValue.includes('Georgia') && !fontValue.includes('Merriweather')) fontClass = 'georgia';
        if (fontValue.includes('Times')) fontClass = 'times';
        if (fontValue.includes('Arial')) fontClass = 'arial';
        
        // Add font class to body (optional for screen, but good for consistency)
        document.body.classList.add('font-' + fontClass);

        // Save preferences
        localStorage.setItem('resume-reader-font', fontValue);
        localStorage.setItem('resume-reader-size', size);
        localStorage.setItem('resume-reader-texture', texture);
        
        // Update PDF link
        // Map texture value to filename part
        var textureName = 'clean';
        if (texture === 'texture-paper') textureName = 'paper';
        if (texture === 'texture-sepia') textureName = 'sepia';
        if (texture === 'texture-dark') textureName = 'dark';
        
        updatePdfLink('classic', { font: fontClass, texture: textureName });
    }

    function updatePdfLink(theme, options) {
        var pdfLinks = document.querySelectorAll('a[href$=".pdf"]');
        pdfLinks.forEach(function(a) {
            var filename = 'resume';
            
            if (theme === 'clean') {
                // Options is 'dark' or null
                if (options === 'dark') {
                    filename += '-dark';
                }
            } else if (theme === 'modern') {
                // Options is color string
                filename += '-modern';
                if (options && options !== 'blue') {
                    filename += '-' + options;
                }
            } else if (theme === 'bold') {
                filename += '-bold';
                // Options is color string. Red is default for Bold.
                if (options && options !== 'red') {
                    filename += '-' + options;
                }
            } else if (theme === 'classic') {
                filename += '-classic';
                // Options is object { font, texture }
                if (options) {
                    if (options.font && options.font !== 'merriweather') {
                        filename += '-' + options.font;
                    }
                    if (options.texture && options.texture !== 'clean') {
                        filename += '-' + options.texture;
                    }
                }
            } else {
                filename += '-' + theme;
            }
            
            a.href = filename + '.pdf';
        });
    }

    // Initialize theme from localStorage if available
    document.addEventListener('DOMContentLoaded', function() {
        // Dynamic Background Movement
        var ticking = false;
        document.addEventListener('mousemove', function(e) {
            if (!ticking) {
                window.requestAnimationFrame(function() {
                    var moveX = (e.clientX - window.innerWidth / 2) * -0.05;
                    var moveY = (e.clientY - window.innerHeight / 2) * -0.05;
                    document.documentElement.style.setProperty('--bg-move-x', moveX + 'px');
                    document.documentElement.style.setProperty('--bg-move-y', moveY + 'px');
                    ticking = false;
                });
                ticking = true;
            }
        });

        var scrollTicking = false;
        document.addEventListener('scroll', function() {
            if (!scrollTicking) {
                window.requestAnimationFrame(function() {
                    var scrollY = window.scrollY;
                    document.documentElement.style.setProperty('--bg-scroll-y', (scrollY * -0.2) + 'px');
                    scrollTicking = false;
                });
                scrollTicking = true;
            }
        });

        var savedTheme = localStorage.getItem('resume-theme');
        var savedColor = localStorage.getItem('resume-modern-color');
        
        // Restore Reader View preferences
        var savedFont = localStorage.getItem('resume-reader-font');
        var savedSize = localStorage.getItem('resume-reader-size');
        var savedTexture = localStorage.getItem('resume-reader-texture');

        if (savedFont) document.getElementById('reader-font').value = savedFont;
        if (savedSize) document.getElementById('reader-size').value = parseInt(savedSize);
        if (savedTexture) document.getElementById('reader-texture').value = savedTexture;

        if (savedColor) {
            var colorSelect = document.getElementById('color-select');
            if (colorSelect) {
                colorSelect.value = savedColor;
            }
        }

        var savedBg = localStorage.getItem('resume-modern-bg');
        if (savedBg) {
            var bgSelect = document.getElementById('bg-select');
            if (bgSelect) {
                bgSelect.value = savedBg;
            }
        }

        if (savedTheme) {
            var select = document.getElementById('theme-select');
            if (select) {
                // Handle legacy "dark" theme preference by switching to clean + dark mode
                if (savedTheme === 'dark') {
                    savedTheme = 'clean';
                    localStorage.setItem('resume-dark-mode', 'true');
                }
                
                select.value = savedTheme;
                // Don't fade on initial load
                // changeTheme(savedTheme); 
                
                // Manually trigger logic without fade
                var link = document.getElementById('theme-style');
                if (link) {
                    link.href = 'theme-' + savedTheme + '.css?v=' + new Date().getTime();
                }
                
                // Show controls
                if (savedTheme === 'modern' || savedTheme === 'bold') {
                    document.getElementById('color-picker-container').style.display = 'block';
                    var colorSelect = document.getElementById('color-select');
                    changeColor(colorSelect.value);
                    
                    if (savedTheme === 'modern' && savedBg) {
                        changeBackground(savedBg);
                    } else {
                        // Hide bg select for bold theme
                        document.getElementById('bg-select').style.display = 'none';
                        document.querySelector('label[for="bg-select"]').style.display = 'none';
                    }
                } else if (savedTheme === 'clean') {
                    document.getElementById('dark-mode-container').style.display = 'block';
                    var isDark = localStorage.getItem('resume-dark-mode') === 'true';
                    document.getElementById('dark-mode-toggle').checked = isDark;
                    toggleDarkMode(isDark);
                } else if (savedTheme === 'classic') {
                    document.getElementById('reader-view-container').style.display = 'block';
                    updateReaderView();
                } else {
                    updatePdfLink(savedTheme, null);
                }
            }
        } else {
            // Default initialization
            // changeTheme('clean');
            // Manual init for default
            document.getElementById('dark-mode-container').style.display = 'block';
            updatePdfLink('clean', null);
        }
    });
</script>
